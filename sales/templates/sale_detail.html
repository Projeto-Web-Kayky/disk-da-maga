{% extends 'base.html' %}
{% block title %}Comanda #{{ sale.id }}{% endblock %}
{% block content %}

<div id="sale-detail" class="p-6 max-w-5xl mx-auto space-y-4">

    <!-- Cabeçalho da comanda -->
    <div class="flex flex-wrap justify-between items-center bg-red-800 text-white rounded-lg p-4 shadow-md">
        <div>
            <h2 class="text-2xl font-bold">Comanda #{{ sale.id }}</h2>
            <p>Cliente: {% if sale.client %}{{ sale.client.name }}{% else %}{{ sale.client_name }}{% endif %}</p>
            <p>Status: <span class="font-semibold">{{ sale.status|title }}</span></p>
        </div>

        <div class="flex flex-col md:flex-row gap-2 mt-3 md:mt-0">
            <button class="btn btn-sm btn-accent" onclick="document.getElementById('add-item-modal').showModal()">+
                Adicionar Item</button>
            <a href="{% url 'sale_list' %}" class="btn btn-sm">Voltar</a>
        </div>
    </div>

    <!-- Itens da comanda -->
    <div id="sale-items" class="bg-white rounded-lg shadow p-4">
        {% include 'partials/sale_items_fragment.html' %}
    </div>

    <!-- Pagamento e ações -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="md:col-span-2"></div>
        <div class="bg-red-900 text-white rounded-lg p-4 shadow space-y-2">
            <p class="font-bold text-lg">Resumo</p>
            <p>Total: <span class="font-semibold">R$ {{ sale.total }}</span></p>
            <p>Pago: <span>R$ {{ sale.paid_amount }}</span></p>
            <p>Saldo: <span>R$ {{ sale.balance }}</span></p>

            {% if sale.status == 'open' %}
            <button class="btn btn-success btn-sm w-full"
                onclick="document.getElementById('pay-modal').showModal()">Registrar Pagamento</button>

            <form hx-post="{% url 'cancel_sale' sale.id %}" hx-target="#sale-detail" hx-swap="outerHTML" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning btn-sm w-full mt-2">Cancelar Comanda</button>
            </form>
            {% else %}
            <form hx-post="{% url 'reopen_sale' sale.id %}" hx-target="#sale-detail" hx-swap="outerHTML" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn btn-accent btn-sm w-full mt-2">Reabrir Comanda</button>
            </form>
            {% endif %}
        </div>
    </div>

</div>

<!-- Modal: Adicionar Item -->
<dialog id="add-item-modal" class="modal">
    <div class="modal-box w-11/12 max-w-md">
        <h3 class="font-bold text-lg mb-4">Adicionar Item à Comanda</h3>

        <form hx-post="{% url 'add_item' sale.id %}" hx-target="#sale-items" hx-swap="outerHTML" method="POST"
            class="flex flex-col gap-3">

            {% csrf_token %}

            <label class="text-sm font-semibold">Produto</label>
            <select name="product_id" required class="select select-bordered w-full">
                <option value="" disabled selected>Selecione um produto</option>
                {% for product in products %}
                <option value="{{ product.pk }}">
                    {{ product.name }} — R${{ product.sale_price }} (Estoque: {{ product.quantity }})
                </option>
                {% endfor %}
            </select>

            <label class="text-sm font-semibold">Quantidade</label>
            <input type="number" name="quantity" value="1" min="1" required class="input input-bordered w-1/2">

            <div class="flex justify-end gap-2 mt-2">
                <button type="button" class="btn"
                    onclick="document.getElementById('add-item-modal').close()">Cancelar</button>
                <button type="submit" class="btn btn-accent">Adicionar</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
</dialog>

<!-- Modal: Pagamento -->
<dialog id="pay-modal" class="modal">
    <div class="modal-box w-11/12 max-w-md">
        <h3 class="font-bold text-lg mb-4">Registrar Pagamento</h3>

        <form hx-post="{% url 'pay_sale' sale.id %}" hx-target="#sale-detail" hx-swap="outerHTML" method="POST"
            class="flex flex-col gap-3">

            {% csrf_token %}
            <input type="number" name="amount" step="0.01" required placeholder="Valor a pagar"
                class="input input-bordered">

            <select name="method" class="select select-bordered">
                <option value="pix">PIX</option>
                <option value="cash">Dinheiro</option>
                <option value="card">Cartão</option>
            </select>

            <input type="text" name="note" placeholder="Observação (opcional)" class="input input-bordered">

            <div class="flex justify-end gap-2 mt-2">
                <button type="button" class="btn"
                    onclick="document.getElementById('pay-modal').close()">Cancelar</button>
                <button type="submit" class="btn btn-success">Confirmar Pagamento</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop"><button>fechar</button></form>
</dialog>

{% endblock %}